services:
  # ==========================================================================
  # Laravel Octane App (Stateless)
  # ==========================================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pcommerce_app
    restart: unless-stopped
    ports:
      - '8000:8000'
    environment:
      APP_NAME: P-Commerce
      APP_ENV: production
      APP_DEBUG: 'false'
      APP_URL: http://localhost:8000
      
      # Database
      DB_CONNECTION: pgsql
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE:-pcommerce}
      DB_USERNAME: ${DB_USERNAME:-pcommerce}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      
      # Cache & Queue
      CACHE_STORE: redis
      QUEUE_CONNECTION: redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      
      # Session: Stateless (no server-side sessions)
      SESSION_DRIVER: array
      
      # Octane
      OCTANE_SERVER: swoole
      
      # Keycloak (Stateless JWT Auth)
      KEYCLOAK_BASE_URL: http://keycloak:8080
      KEYCLOAK_REALM: pcommerce
      KEYCLOAK_CLIENT_ID: pcommerce-app
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET:-change-me-in-production}
      
      # Default tenant for multi-tenancy
      DEFAULT_TENANT_ID: ${DEFAULT_TENANT_ID:-default}
      
      # SSR Server (for SEO pages) - enable with: docker-compose --profile ssr up
      INERTIA_SSR_ENABLED: ${INERTIA_SSR_ENABLED:-false}
      INERTIA_SSR_URL: ${INERTIA_SSR_URL:-http://ssr:13714}
      
    volumes:
      - ./php.ini:/usr/local/etc/php/conf.d/99-custom.ini:ro
      - app_storage:/var/www/storage
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - pcommerce_network
    healthcheck:
      test: ['CMD', 'php', 'artisan', 'octane:status']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # ==========================================================================
  # SSR Server (Inertia Server-Side Rendering for SEO)
  # Optional - app works without it, just without SSR
  # ==========================================================================
  ssr:
    build: .
    container_name: pcommerce_ssr
    restart: unless-stopped
    entrypoint: ['node', '/var/www/bootstrap/ssr/ssr.mjs']
    environment:
      NODE_ENV: production
    expose:
      - '13714'
    networks:
      - pcommerce_network
    deploy:
      resources:
        limits:
          memory: 256M
    profiles:
      - ssr

  # ==========================================================================
  # Queue Worker (Same image, different entrypoint)
  # Processes jobs from multiple queues with priority order
  # ==========================================================================
  worker:
    build: .
    container_name: pcommerce_worker
    restart: unless-stopped
    entrypoint: >
      php /var/www/artisan queue:work redis
      --queue=high,orders,notifications,default,images,documents,search,reports,cleanup
      --tries=3
      --sleep=3
      --timeout=300
      --max-jobs=1000
      --max-time=3600
    environment:
      APP_ENV: production
      DB_CONNECTION: pgsql
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE:-pcommerce}
      DB_USERNAME: ${DB_USERNAME:-pcommerce}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      CACHE_STORE: redis
      QUEUE_CONNECTION: redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      SESSION_DRIVER: array
      KEYCLOAK_BASE_URL: http://keycloak:8080
      KEYCLOAK_REALM: pcommerce
      KEYCLOAK_CLIENT_ID: pcommerce-app
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET:-change-me-in-production}
    volumes:
      - app_storage:/var/www/storage
    depends_on:
      - postgres
      - redis
    networks:
      - pcommerce_network
    deploy:
      resources:
        limits:
          memory: 512M

  # ==========================================================================
  # Heavy Jobs Worker (Separate worker for resource-intensive jobs)
  # ==========================================================================
  worker-heavy:
    build: .
    container_name: pcommerce_worker_heavy
    restart: unless-stopped
    entrypoint: >
      php /var/www/artisan queue:work redis
      --queue=images,documents,reports
      --tries=2
      --sleep=5
      --timeout=600
      --max-jobs=100
      --max-time=3600
    environment:
      APP_ENV: production
      DB_CONNECTION: pgsql
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE:-pcommerce}
      DB_USERNAME: ${DB_USERNAME:-pcommerce}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      CACHE_STORE: redis
      QUEUE_CONNECTION: redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      SESSION_DRIVER: array
      KEYCLOAK_BASE_URL: http://keycloak:8080
      KEYCLOAK_REALM: pcommerce
      KEYCLOAK_CLIENT_ID: pcommerce-app
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET:-change-me-in-production}
    volumes:
      - app_storage:/var/www/storage
    depends_on:
      - postgres
      - redis
    networks:
      - pcommerce_network
    deploy:
      resources:
        limits:
          memory: 1G
    profiles:
      - heavy-worker

  # ==========================================================================
  # Scheduler (Cron jobs)
  # ==========================================================================
  scheduler:
    build: .
    container_name: pcommerce_scheduler
    restart: unless-stopped
    entrypoint: ['/bin/sh', '-c', 'while true; do php /var/www/artisan schedule:run --verbose --no-interaction; sleep 60; done']
    environment:
      APP_ENV: production
      DB_CONNECTION: pgsql
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE:-pcommerce}
      DB_USERNAME: ${DB_USERNAME:-pcommerce}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      CACHE_STORE: redis
      QUEUE_CONNECTION: redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      SESSION_DRIVER: array
    volumes:
      - app_storage:/var/www/storage
    depends_on:
      - postgres
      - redis
    networks:
      - pcommerce_network

  # ==========================================================================
  # PostgreSQL Database
  # ==========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: pcommerce_postgres
    restart: always
    environment:
      POSTGRES_DB: pcommerce
      POSTGRES_USER: pcommerce
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U pcommerce -d pcommerce']
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - pcommerce_network

  # ==========================================================================
  # Redis (Cache & Queues - No Sessions in stateless mode)
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: pcommerce_redis
    restart: always
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - '6379:6379'
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - pcommerce_network

  # ==========================================================================
  # Keycloak (Identity & Access Management)
  # ==========================================================================
  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    container_name: pcommerce_keycloak
    command: start-dev --import-realm
    restart: unless-stopped
    environment:
      # Admin credentials
      KC_BOOTSTRAP_ADMIN_USERNAME: ${KEYCLOAK_ADMIN_USERNAME:-admin}
      KC_BOOTSTRAP_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      
      # Database (PostgreSQL)
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: ${DB_USERNAME:-pcommerce}
      KC_DB_PASSWORD: ${DB_PASSWORD:-postgres}
      
      # HTTP/Proxy settings
      KC_HTTP_ENABLED: 'true'
      KC_HOSTNAME_STRICT: 'false'
      KC_PROXY_HEADERS: xforwarded
      KC_HEALTH_ENABLED: 'true'
      KC_METRICS_ENABLED: 'true'
      
      # Logging
      KC_LOG_LEVEL: INFO
    ports:
      - '8080:8080'
    volumes:
      # Import realm on first startup
      - ./realms/pcommerce.json:/opt/keycloak/data/import/pcommerce.json:ro
      # Persistent themes (optional)
      - keycloak_themes:/opt/keycloak/themes
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - pcommerce_network

  # ==========================================================================
  # Nginx Reverse Proxy (Production)
  # ==========================================================================
  nginx:
    image: nginx:alpine
    container_name: pcommerce_nginx
    restart: unless-stopped
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./public:/var/www/public:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - app
    networks:
      - pcommerce_network

  # ==========================================================================
  # Mailpit (Development Email Testing)
  # ==========================================================================
  mailpit:
    image: axllent/mailpit
    container_name: pcommerce_mailpit
    restart: unless-stopped
    ports:
      - '1025:1025'  # SMTP
      - '8025:8025'  # Web UI
    networks:
      - pcommerce_network
    profiles:
      - dev

networks:
  pcommerce_network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  keycloak_themes:
    driver: local
  app_storage:
    driver: local
  nginx_logs:
    driver: local
